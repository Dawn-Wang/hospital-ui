$(function(){

	MU.init();
	
	$('.navmenu-v li.sub').hover(function() {    //左侧分类导航
        $(this).addClass('cur');
    }, function() {
        $(this).removeClass('cur');
    });

    $('.navmenu-v li > a').click(function() {    //左侧分类导航
        $('.navmenu-v li > a').removeClass('on');
        $(this).addClass('on').parents('ul').prev('a').addClass('on');
    });

});

var MU = {
	init: function(){
		$("body").on('focus blur','input[type=text],input[type=password]',function(e){//文本框得失光标事件
			if($(this).attr('data-flag')){return false;}
			if(e.type=='focusin'){
				var str = $.trim($(this).val());
				if(str==this.defaultValue){
					$(this).val('');
				}
				$(this).addClass('focus');
				$(this).parent().next('.errorTxt').hide();
			}else{
				var str = $.trim($(this).val());
				if(str==''){
					$(this).val(this.defaultValue);
				}
				$(this).removeClass('focus');
			}
		});

		$('.person-info').hover(function() {   //个人信息
			$(this).children('a.nic-name').addClass('cur');
			$(this).children('ul').removeClass('dis-no');
		}, function() {
			$(this).children('a.nic-name').removeClass('cur');
			$(this).children('ul').addClass('dis-no');
		});

	},
	msgTips: function(status,txt,timeout,callback){
		this.removeTips();
		var flag = status.match('loading')=='loading';
		var zindex = parseInt( new Date().getTime()/1000 );
		var html = '<div class="msgbox_layer_wrap" id="msgTips" style="z-index:'+zindex+'"><span class="msgbox_layer"><span class="icon_clear"></span><span class="icon '+status+'"></span>'+txt+'<span class="icon_end"></span></span></div>';
		$('body').append(html);
		if (flag) {
			$("#msgTips .loading").removeClass('icon');
			if($("div#filter").length<=0){
				$("body").append('<div id="loadingBg"></div>');
				$("#loadingBg").css({
					"height": $(document).height()
				});
			}
		}else{
			$("#msgTips .icon_clear").remove();
			setTimeout(this.removeTips,timeout||1500);
			if(callback){
				var lon = parseInt(timeout) + 400;
				setTimeout(callback,lon);
			}
		};
	},
	removeTips: function(){
		$("#msgTips,#loadingBg").remove();
	},
	conFirm: function(title,msg,ConfirmFun){
		var html='<div class="dialog">'+msg+'</div><div class="btnbox"><a id="ConfirmFun" href="javascript:;" class="save_btn btn"><em>确&nbsp;定</em></a><a href="javascript:void(0)" class="clear_btn btn btn-gray" onclick="MU.close(this)"><em>取&nbsp;消</em></a></div>';
		this.alert(html,500,title);
		var that = this;
		if(ConfirmFun){
			$("#ConfirmFun").on('click',function(){
				ConfirmFun();
				that.close();
			})
		}
	},
	getCookie: function(name){//取cookie
		if(navigator.cookieEnabled){
			var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
			if(arr != null) return decodeURI(arr[2]);
		}
	},
	setCookie: function(name, value, day){//写cookie
		var exp  = new Date();
		exp.setTime(exp.getTime() + day * 24 * 60 * 60 * 1000);
		if(navigator.cookieEnabled){
			document.cookie = name + "=" + encodeURI(value) + ";expires=" + exp.toGMTString();
		}
	},
	request: function(str){//获取URL参数
		var href = window.location.href;
		var p = str + '=';
		var array = href.split(p);
		if( array.length>1 ){
			var b = array[1].split('&').length;
			return b>1 ? array[1].split('&')[0] : array[1];
		}else{
			return undefined;
		}
	},
	isNum: function(str){//是否正整数
		var reg = /^[1-9]+[0-9]*]*$/;
		return reg.test(str);
	},
	isUrl: function(str){
		var reg = /^((https|http|ftp|rtsp|mms)?:\/\/)?(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?(([0-9]{1,3}\.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+\.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z]\.[a-z]{2,6})(:[0-9]{1,})?((\/?)|(\/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+\/?)$/i;
		return reg.test(str);
	},
	isPhone: function(str){//验证手机
		//var reg = /^0?(13[0-9]|15[012356789]|18[02356789]|14[57])[0-9]{8}$/
		var reg = /^(1(([35][0-9])|(47)|(45)|[7][0678]|[8][0123456789]))\d{8}$/
		return reg.test(str);
	},
	isEmail: function(str){//验证E-mail
		var apos = str.indexOf("@");
		var dotpos = str.lastIndexOf(".");
		return !(apos<1||dotpos-apos<2);
	},
	delay: function(fn,timeout){//延时（暂停）函数
		var dfd = $.Deferred();
		setTimeout(function() {
			dfd.resolve(fn());
		}, timeout || 0);
		return dfd.promise();
	},
	alert: function(msg,w,title,ConfirmFun,isClose){
		var _this = this;
		var len = $("div[name=wh_alert]").length + 1;
		var html = '<div class="alert" style="width:'+w+'px" id="wh_alert_'+len+'" name="wh_alert">';
		if(title != ''){
			html = html + '<div class="title"><a href="javascript:;" onclick="MU.close(this)"></a>'+title+'</div>'+msg;
		}else{
			html = html + msg;
		}
		if(ConfirmFun){
			html = html + '<div class="btnbox"><a href="javascript:;" class="save_btn btn"><em>确&nbsp;定</em></a><a href="javascript:void(0)" class="clear_btn btn btn-gray" onclick="MU.close(this)"><em>取&nbsp;消</em></a></div></div>';
			$("body").prepend(html);
			$('#wh_alert_'+len).find('.save_btn').on('click',function(){
				ConfirmFun();
				if(isClose==undefined||isClose){
					_this.close();
				}
			})
		}else{
			html = html + '</div>';
			$("body").prepend(html);
		}
		this.mask();
		this.center($('#wh_alert_'+len));
		if(title != ''){this.drag('wh_alert_'+len);}
	},
	show: function(obj){
		var _this = this;
		$(window).scroll(function(){_this.scenter(obj);});
		$(window).resize(function(){_this.scenter(obj);});
	},
	scenter: function(obj){
		var windowWidth = document.documentElement.clientWidth;
		var windowHeight = document.documentElement.clientHeight;
		var popupHeight = $(obj).height();
		var popupWidth = $(obj).width();
		$(obj).css({
			"top": (windowHeight-popupHeight)/2+$(document).scrollTop(),
			"left": (windowWidth-popupWidth)/2
		});
	},
	center: function(obj,flag){
		var _this = this;
		var windowWidth = document.documentElement.clientWidth;
		var windowHeight = document.documentElement.clientHeight;
		var popupHeight = $(obj).height();
		var popupWidth = $(obj).width();
		//var top = (windowHeight-popupHeight)/2+$(document).scrollTop() > 0 ? (windowHeight-popupHeight)/2+$(document).scrollTop() : 46;
		var top = ($(window).height() - popupHeight) / 2;
		var index = parseInt( new Date().getTime()/1000 );
		$(obj).css({
			"opacity": 0,
			"top": top-40,
			"left": (windowWidth-popupWidth)/2,
			"z-index":index
		});
		$(obj).animate({"top":'+='+'40px',"opacity":"1"},400,function(){});
	},
	close: function(obj){
		var obj = obj || $(".alert:first").find("div.title").find('a');
		$(obj).parents("div[name=wh_alert]").animate({"top":'-='+'60px',"opacity":"0"},400,function(){
			$(obj).parents("div[name=wh_alert]").remove();
			if($("div.alert").length<=0)
				$("#filter").animate({"opacity":"0"},400,function(){$("#filter").remove();});
		})
	},
	loading: function(msg){
		$("body").prepend('<div id="msg_loading" class="msgbox"><em></em><span class="loading"></span><span class="msg_right"></span></div>');
		$("#msg_loading .loading").text(msg);
		this.center($("#msg_loading"));
		this.mask();
	},
	removeLoad: function(){
		$("#msg_loading").remove();
		this.delMask();
	},
	mask: function(){
		if($("#filter").length<=0){
			var mybg="<div id='filter'></div>";
			var h = document.documentElement.scrollHeight;//$("body").height() > document.documentElement.clientHeight ? $("body").height() : document.documentElement.clientHeight;
			$("body").append(mybg);
			$("div#filter").height(h);
			$("#filter").animate({"opacity":"0.75"},400);
		}
	},
	delMask: function(){
		$("#filter").remove();
	},
	drag: function(dragObj){
		var _this = this;
		var drag = typeof dragObj === 'string' ? document.getElementById(dragObj) : dragObj;
		var dTitle = drag.getElementsByTagName('div')[0];
		var disX = disY = 0;
		var isDown = false;
//		drag.style.position = 'absolute';
		dTitle.style.cursor = 'move';

		_this.addHandler(dTitle, "mousedown", function(event) {
			drag.style.zIndex = parseInt( new Date().getTime()/1000 );
			event = window.event || event;
			if (event.button == 0 || event.button == 1) {
				(!window.ActiveXObject) ?
					event.preventDefault():
					event.returnValue = false; //取消默认行为
				disX = event.clientX - drag.offsetLeft;
				disY = event.clientY - drag.offsetTop;
				isDown = true;
			}
		});

		_this.addHandler(document, "mousemove", function(event) {
			event = window.event || event;
			if(isDown) {
				drag.style.margin = 0;
				//鼠标点击处离屏幕左侧距离- 鼠标点击离弹窗左侧距离 = 弹窗离左边距离
				var leftPos = event.clientX - disX,
					topPos = event.clientY - disY,
					clientWidth = document.documentElement.clientWidth || document.body.clientWidth,
					clientHeight = document.documentElement.clientHeight || document.body.clientHeight;

				if(leftPos < 0 ) leftPos = 0;
				if(leftPos > clientWidth - drag.offsetWidth)
					leftPos = clientWidth - drag.offsetWidth;
				if(topPos < 0) topPos = 0;
				if(topPos > clientHeight - drag.offsetHeight)
					topPos = clientHeight - drag.offsetHeight;

				drag.style.left =  leftPos+ 'px';
				drag.style.top =  topPos+ 'px';
			}

		});

		_this.addHandler(document, "mouseup", function() {
			isDown = false;
		});
	},
	addHandler: function(node, type, handler) {
		return node.addEventListener ?
			node.addEventListener(type, handler, false) : //非ie 添加事件
			node.attachEvent('on' + type, handler); //ie添加事件
	},
	between: function(m,b){
		return Math.round(Math.random() * (b-m)) + m;
	}
};
